# Firebird Telegram Bot


[Telegram Bot](api.telegram.org) based on Firebird SQL procedures.

Written to get information about/from Firebird database of [MIS Infoclinic][](medis-plus.ru).

Requered external tool for sending and receiving HTTP requests to [Telegram Bot API](https://core.telegram.org/bots/api)
(in case of [MIS Infoclinic][] you can use its ReplServer module for http exchange).


Common workflow:

- Installing this bot on [database](#database)
- Installing and setting up tool for http exchange
- Creating specific [commands](#commands) reuqured for this database.
Each command is presented by name and SQL-query
which will be executed in database to get result for that command.
- Specifying allowed users and chats to prevent unauthorized using of the bot
- Running bot
- Using bot to get information from/about database:
    - send some command to the bot in telegram and receive result,
    gotten as a result of executing SQL-query related to that command
    - use /subscribe command to receiving results of another command by schedule
    (for example, once a day)


### Table of content

<!-- MarkdownTOC autolink="true" lowercase="all" uri_encoding="false" -->

- [Commands](#commands)
    - [help](#help)
    - [subscribe](#subscribe)
    - [unsubscribe](#unsubscribe)
- [Database](#database)
    - [Tables](#tables)
        - [fbtb_bot](#fbtb_bot)
        - [fbtb_command](#fbtb_command)
        - [fbtb_command_request](#fbtb_command_request)
        - [fbtb_command_subscription](#fbtb_command_subscription)
    - [Procedures](#procedures)
        - [fbtb_get_requests](#fbtb_get_requests)
        - [fbtb_process_command_request](#fbtb_process_command_request)
        - [fbtb_process_subscriptions](#fbtb_process_subscriptions)
        - [fbtb_response_handler](#fbtb_response_handler)
        - [fbtb_httpclient_loader](#fbtb_httpclient_loader)
        - [fbtb_httpclient_handler](#fbtb_httpclient_handler)

<!-- /MarkdownTOC -->


## Commands


Below is a basic set of commands.

### help

Using: `/help`

Shows supported commands

### subscribe

Using: `/subscribe COMMAND REPEAT_AFTER [START_DATE] [END_DATE] [FROM_TIME] [TO_TIME] [NO_SOUND]`

Adds subscription to the command `COMMAND` for the chat where the `/subscribe` was execute.
Subscription means that in period from `START_DATE` to `END_DATE` the `COMMAND` will being executed automatically between `FROM_TIME` and `TO_TIME` with delay `REPEAT_AFTER` and result will being send to the current chat (without notification if `NO_SOUND` > 0.

Arguments:

- `COMMAND` - name of command
- `REPEAT_AFTER` - minimum (but **not guaranteed**) delay between repeating the command,
posible values:
    - `0` - send as often as posible;
    - `5s` - next sending in at least 5 seconds after previous;
    - `3m` - next sending in at least 3 minutes after previous;
    - `1h` - next sending in at least 1 hour after previous;
    - `2d` - next sending in at least 2 days after previous;
    - `7w` - next sending in at least 7 weeks after previous';
- (_optional_) `START_DATE` - date after which subscription will be processed
- (_optional_) `END_DATE` - date before which subscription will be processed
- (_optional_) `END_DATE` - date before which subscription will be processed
- (_optional_) `FROM_TIME` - start of a time interval within a day when subscription will be processed
- (_optional_) `END_TIME` - end of a time interval within a day when subscription will be processed
- (_optional_) `NO_SOUND` - if scpecified and more than `0` messages with result will be send by bot without sound.



### unsubscribe

Using: `/unsubscribe COMMAND`

Cancels subscription for COMMAND.


## Database

To prevent free disk space exceeding for production DB by a lot of requests (including because of DDOS) 
**STRONGLY** recommend to create separate database on separate disc.


### Tables

#### fbtb_bot

Stores information about each bot in that database.

Fields:

- bot_id
- bot_name
- bot_token
- last_updates
- update_delay_in_milliseconds
- message_prefix
- messages_per_day_limit
- enabled
- data_db
- data_user
- data_password


#### fbtb_command

Stores information about all supported user commands for each bot in that database.


Fields:

- command_id
- bot_id
- command_name
- command_description
- result_statement
- allowed_chat_id_list
- allowed_user_id_list


#### fbtb_command_request

Stores information about all received or generated by subscription command requests.


Fields:

- request_id
- command_id
- request_text
- result_text
- result_sent
- result_response
- created
- from_chat_id
- from_user_id
- command_statement
- status (0 - unprocessed, 1 - result is waiting for send, 2 - sent, 3 - ignored/skipped, 4 - failed
- status_info
- status_updated
- subscription_id


#### fbtb_command_subscription

Stores information about all subscriptions.


Fields:

- subscription_id
- command_id
- chat_id
- start_date
- end_date
- from_time
- to_time
- repeat_after
- no_sound


### Procedures


#### fbtb_get_requests

Makes following requests to Telegram Bot API for each enabled bot
(if messages_per_day do not exceed):

- `getUpdates`, if more than [update_delay_in_milliseconds][fbtb_bot] has passed after last the same request
- `sendMessage` for each [fbtb_command_request][] with empty [result_sent][fbtb_command_request]
and non empty [result_text][fbtb_command_request]


#### fbtb_process_command_request

- creates records in [fbtb_command_request][]
- tries to get result by executing [result_statement][fbtb_command]
- updates [status][fbtb_command_request] and [status_info][fbtb_command_request] and [status_updated][fbtb_command_request]


#### fbtb_process_subscriptions

Generates messages for each subscription according to its settings.

- creates surrogate [fbtb_command_request][] record
- executes [fbtb_process_command_request][] for that new record


#### fbtb_response_handler

Processes responses from Telegram Bot API for all sent requests:

- for `sendMessages` responses updates result_sent in command_request
- for `getUpdates` responses parses all commands gotten by the bot
and executes [fbtb_process_command_request][] for each of them
- executes [fbtb_process_subscriptions][] to generate messages for each subscription


#### fbtb_httpclient_loader

Wrapper over get_requests for httpclient task of ReplServer [MIS Infoclinic][] module.


#### fbtb_httpclient_handler

Wrapper over response_handler for httpclient task of ReplServer [MIS Infoclinic][] module



[MIS Infoclinic]: medis-plus.ru

[fbtb_bot]: #fbtb_bot
[fbtb_command]: #fbtb_command
[fbtb_command_request]: #fbtb_command_request

[fbtb_process_command_request]: #fbtb_process_command_request
[fbtb_process_subscriptions]: #fbtb_process_subscriptions
